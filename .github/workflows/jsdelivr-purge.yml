name: Purge jsDelivr Cache

# å·¥ä½œæµè§¦å‘æ¡ä»¶ï¼šå½“å‘ä¸»åˆ†æ”¯æ¨é€æ—¶è‡ªåŠ¨æ‰§è¡Œ
on:
  push:
    branches:
      - main
      - master

# ç¯å¢ƒå˜é‡é…ç½®åŒº
env:
  # éœ€è¦æ¸…ç†ç¼“å­˜çš„æ–‡ä»¶æ‰©å±•åï¼ˆä½¿ç”¨ç©ºæ ¼åˆ†éš”ï¼‰
  TARGET_EXTENSIONS: '.js .css .wasm .json .html .svg .png .jpg .jpeg .gif .webp .ico .woff .woff2 .ttf .eot'
  
  # æ˜¯å¦æ¸…ç†æ— æ‰©å±•åæ–‡ä»¶çš„ç¼“å­˜ï¼ˆtrue/falseï¼‰
  PURGE_NO_EXTENSION: 'false'
  
  # jsDelivr CDN åŸºç¡€ URL æ¨¡æ¿
  CDN_BASE_URL: 'https://cdn.jsdelivr.net/gh/${{ github.repository }}@latest'

jobs:
  purge-cache:
    name: Purge Changed Files Cache
    runs-on: ubuntu-latest
    
    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç ä»“åº“
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´ git å†å²ä»¥æ”¯æŒå¯é çš„å·®å¼‚å¯¹æ¯”
      
      # æ­¥éª¤ 2: è·å–æœ¬æ¬¡æäº¤ä¸­å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨
      - name: Get Changed Files
        id: changed_files
        run: |
          echo "ğŸ” æ£€æµ‹æœ¬æ¬¡æäº¤ä¸­çš„æ–‡ä»¶å˜æ›´..."
          
          # ç¡®å®šæ¯”è¾ƒçš„åŸºå‡†æäº¤
          # ä¼˜å…ˆä½¿ç”¨ github.event.beforeï¼ˆpush å‰çš„ SHAï¼‰ï¼Œå›é€€åˆ° HEAD~1
          BASE_SHA="${{ github.event.before }}"
          CURRENT_SHA="${{ github.sha }}"
          
          # å¤„ç†é¦–æ¬¡æ¨é€åœºæ™¯ï¼ˆbefore ä¸ºå…¨ 0ï¼‰
          if [[ "$BASE_SHA" =~ ^0+$ ]] || [ -z "$BASE_SHA" ]; then
            echo "âš ï¸  æ£€æµ‹åˆ°é¦–æ¬¡æ¨é€æˆ–æ— æ•ˆçš„ before SHAï¼Œä½¿ç”¨ HEAD~1 ä½œä¸ºåŸºå‡†"
            BASE_SHA="HEAD~1"
          fi
          
          # éªŒè¯ BASE_SHA æ˜¯å¦å­˜åœ¨
          if ! git rev-parse --verify "$BASE_SHA" >/dev/null 2>&1; then
            echo "âš ï¸  åŸºå‡†æäº¤ $BASE_SHA ä¸å­˜åœ¨ï¼Œä½¿ç”¨ HEAD ä½œä¸ºå½“å‰æäº¤çš„å˜æ›´"
            # å¯¹äºé¦–æ¬¡æäº¤æˆ–ç‰¹æ®Šæƒ…å†µï¼Œè·å–å½“å‰æäº¤çš„æ‰€æœ‰æ–‡ä»¶
            CHANGED_FILES=$(git ls-tree -r --name-only HEAD 2>/dev/null || echo "")
          else
            # ä½¿ç”¨ git diff è·å–å˜æ›´æ–‡ä»¶åˆ—è¡¨ï¼ˆç©ºå­—èŠ‚åˆ†éš”ï¼Œæ”¯æŒç©ºæ ¼æ–‡ä»¶åï¼‰
            # --diff-filter=ACMR: åŒ…æ‹¬æ–°å¢(A)ã€å¤åˆ¶(C)ã€ä¿®æ”¹(M)ã€é‡å‘½å(R)ï¼Œæ’é™¤åˆ é™¤(D)
            CHANGED_FILES=$(git diff -z --name-only --diff-filter=ACMR "$BASE_SHA" "$CURRENT_SHA" 2>/dev/null | tr '\0' '\n' || echo "")
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´æ–‡ä»¶
          if [ -z "$CHANGED_FILES" ]; then
            echo "âš ï¸  æœªæ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡ç¼“å­˜æ¸…ç†"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          # è¾“å‡ºå˜æ›´æ–‡ä»¶åˆ—è¡¨ï¼ˆç”¨äºè°ƒè¯•ï¼‰
          echo "ğŸ“ å˜æ›´æ–‡ä»¶åˆ—è¡¨ (å¯¹æ¯” $BASE_SHA â†’ $CURRENT_SHA):"
          echo "$CHANGED_FILES" | while IFS= read -r file; do
            [ -n "$file" ] && echo "  - $file"
          done
          
          # å°†å˜æ›´æ–‡ä»¶åˆ—è¡¨ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶ï¼ˆä½¿ç”¨ç©ºå­—èŠ‚åˆ†éš”ä»¥æ”¯æŒç©ºæ ¼ï¼‰
          echo "$CHANGED_FILES" | tr '\n' '\0' > /tmp/changed_files.txt
      
      # æ­¥éª¤ 3: æ ¹æ®é…ç½®çš„æ‰©å±•åè¿‡æ»¤éœ€è¦æ¸…ç†ç¼“å­˜çš„æ–‡ä»¶
      - name: Filter Target Files
        id: filter_files
        if: steps.changed_files.outputs.has_changes == 'true'
        run: |
          echo "ğŸ”§ æ ¹æ®é…ç½®çš„æ‰©å±•åè¿‡æ»¤æ–‡ä»¶..."
          
          # è¯»å–å˜æ›´æ–‡ä»¶åˆ—è¡¨ï¼ˆç©ºå­—èŠ‚åˆ†éš”ï¼‰
          TARGET_FILES=""
          
          # ä½¿ç”¨ while IFS= read æ­£ç¡®å¤„ç†åŒ…å«ç©ºæ ¼çš„æ–‡ä»¶å
          while IFS= read -r -d $'\0' file; do
            [ -z "$file" ] && continue
            
            # è·å–æ–‡ä»¶åï¼ˆbasenameï¼‰
            filename=$(basename "$file")
            
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦åŒ…å«æ‰©å±•åï¼ˆæ˜¯å¦æœ‰ç‚¹ä¸”ç‚¹ä¸åœ¨å¼€å¤´ï¼‰
            if [[ "$filename" == *.* ]] && [[ "$filename" != .* ]]; then
              # æå–æ‰©å±•åï¼ˆè½¬æ¢ä¸ºå°å†™ï¼‰
              ext=$(echo "${filename##*.}" | tr '[:upper:]' '[:lower:]')
              ext_with_dot=".${ext}"
              
              # æ£€æŸ¥æ‰©å±•åæ˜¯å¦åœ¨é…ç½®åˆ—è¡¨ä¸­
              if echo "$TARGET_EXTENSIONS" | grep -q -w "$ext_with_dot"; then
                TARGET_FILES="${TARGET_FILES}${file}"$'\0'
              fi
            else
              # æ— æ‰©å±•åæ–‡ä»¶ï¼šæ ¹æ®é…ç½®å†³å®šæ˜¯å¦æ¸…ç†
              if [ "$PURGE_NO_EXTENSION" = "true" ]; then
                echo "  â„¹ï¸  åŒ…å«æ— æ‰©å±•åæ–‡ä»¶: $file"
                TARGET_FILES="${TARGET_FILES}${file}"$'\0'
              fi
            fi
          done < /tmp/changed_files.txt
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶
          if [ -z "$TARGET_FILES" ]; then
            echo "âš ï¸  æ²¡æœ‰ç¬¦åˆæ‰©å±•åè§„åˆ™çš„æ–‡ä»¶ï¼Œè·³è¿‡ç¼“å­˜æ¸…ç†"
            echo "has_target_files=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "has_target_files=true" >> $GITHUB_OUTPUT
          
          # è¾“å‡ºç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶åˆ—è¡¨
          echo "âœ… éœ€è¦æ¸…ç†ç¼“å­˜çš„æ–‡ä»¶:"
          echo -n "$TARGET_FILES" | while IFS= read -r -d $'\0' file; do
            [ -n "$file" ] && echo "  - $file"
          done
          
          # ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶ï¼ˆç©ºå­—èŠ‚åˆ†éš”ï¼‰
          echo -n "$TARGET_FILES" > /tmp/target_files.txt
      
      # æ­¥éª¤ 4: ç”Ÿæˆ jsDelivr CDN URLs
      - name: Generate CDN URLs
        id: generate_urls
        if: steps.filter_files.outputs.has_target_files == 'true'
        run: |
          echo "ğŸŒ ç”Ÿæˆ jsDelivr CDN URLs..."
          
          # ç”Ÿæˆ CDN URLsï¼ˆé€—å·åˆ†éš”ï¼‰
          CDN_URLS=""
          
          # ä½¿ç”¨ while IFS= read æ­£ç¡®å¤„ç†åŒ…å«ç©ºæ ¼çš„æ–‡ä»¶å
          while IFS= read -r -d $'\0' file; do
            [ -z "$file" ] && continue
            
            # URL ç¼–ç æ–‡ä»¶è·¯å¾„ï¼ˆå¤„ç†ç©ºæ ¼å’Œç‰¹æ®Šå­—ç¬¦ï¼‰
            # å°†ç©ºæ ¼æ›¿æ¢ä¸º %20ï¼Œå…¶ä»–ç‰¹æ®Šå­—ç¬¦ä¿æŒåŸæ ·ï¼ˆjsDelivr æ”¯æŒï¼‰
            encoded_file=$(echo "$file" | sed 's/ /%20/g')
            
            # æ„å»ºå®Œæ•´çš„ CDN URL
            url="${CDN_BASE_URL}/${encoded_file}"
            
            # æ·»åŠ åˆ° URL åˆ—è¡¨ï¼ˆä½¿ç”¨é€—å·åˆ†éš”ï¼‰
            if [ -z "$CDN_URLS" ]; then
              CDN_URLS="$url"
            else
              CDN_URLS="${CDN_URLS},${url}"
            fi
          done < /tmp/target_files.txt
          
          # æ£€æŸ¥æ˜¯å¦æˆåŠŸç”Ÿæˆ URLs
          if [ -z "$CDN_URLS" ]; then
            echo "âŒ æœªèƒ½ç”Ÿæˆæœ‰æ•ˆçš„ CDN URLs"
            echo "has_urls=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "has_urls=true" >> $GITHUB_OUTPUT
          
          # è¾“å‡ºç”Ÿæˆçš„ URLsï¼ˆç”¨äºè°ƒè¯•ï¼‰
          echo "ğŸ“‹ å¾…æ¸…ç†çš„ CDN URLs:"
          echo "$CDN_URLS" | tr ',' '\n' | while IFS= read -r url; do
            [ -n "$url" ] && echo "  - $url"
          done
          
          # ä¿å­˜ URLs åˆ°è¾“å‡º
          echo "urls=$CDN_URLS" >> $GITHUB_OUTPUT
      
      # æ­¥éª¤ 5: æ‰§è¡Œ jsDelivr ç¼“å­˜æ¸…ç†
      - name: Purge jsDelivr Cache
        if: steps.generate_urls.outputs.has_urls == 'true'
        uses: egad13/purge-jsdelivr-cache@v1
        with:
          url: ${{ steps.generate_urls.outputs.urls }}
          attempts: 3  # å¤±è´¥é‡è¯•æ¬¡æ•°
      
      # æ­¥éª¤ 6: è¾“å‡ºæ‰§è¡Œç»“æœæ‘˜è¦
      - name: Summary
        if: always()
        run: |
          echo "## ğŸ¯ jsDelivr ç¼“å­˜æ¸…ç†æ‰§è¡Œæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.changed_files.outputs.has_changes }}" != "true" ]; then
            echo "âš ï¸ **ç»“æœ**: æœªæ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.filter_files.outputs.has_target_files }}" != "true" ]; then
            echo "âš ï¸ **ç»“æœ**: å˜æ›´æ–‡ä»¶ä¸ç¬¦åˆæ‰©å±•åè§„åˆ™" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**é…ç½®çš„æ‰©å±•å**: \`$TARGET_EXTENSIONS\`" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.generate_urls.outputs.has_urls }}" != "true" ]; then
            echo "âŒ **ç»“æœ**: æœªèƒ½ç”Ÿæˆæœ‰æ•ˆçš„ CDN URLs" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **ç»“æœ**: ç¼“å­˜æ¸…ç†å·²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**æ¸…ç†çš„ URLs**:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.generate_urls.outputs.urls }}" | tr ',' '\n' >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
